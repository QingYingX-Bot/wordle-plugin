import common from '../../../lib/common/common.js';

let db;
(async () => {
  db = await import('../utils/data/db.js').then(m => m.default || m);
})();

export class Control extends plugin {
  constructor() {
    super({
      name: 'Control',
      dsc: 'Wordleæ¸¸æˆå¼€å…³æ§åˆ¶',
      event: 'message', 
      priority: 5000,
      rule: [
        {
          reg: /^#(å¼€å¯|å…³é—­)wordleæ¸¸æˆ$/i,
          fnc: 'toggleWordle'
        },
        {
          reg: /^#wordle\s*(å¸®åŠ©|help)?$/i,
          fnc: 'showWordleHelp'
        }
      ]
    });
    
    this.db = db;
  }
  
  /**
   * æ˜¾ç¤ºWordleæ¸¸æˆæ€»å¸®åŠ©
   * @param {*} e - æ¶ˆæ¯äº‹ä»¶å¯¹è±¡
   * @returns {Promise<boolean>} - å¤„ç†ç»“æœ
   */
  async showWordleHelp(e) {
    const match = e.msg.match(/^#wordle\s*(å¸®åŠ©|help)?$/i);
    if (!match) {
      return false;
    }
    
    // åˆ†å‰²æˆ4ä¸ªç‹¬ç«‹çš„å¸®åŠ©æ¶ˆæ¯ï¼ˆåŠŸèƒ½æ§åˆ¶åœ¨æœ€ä¸Šé¢ï¼‰
    const msg = [
      [
        'âš™ï¸ åŠŸèƒ½æ§åˆ¶\n\n',
        '#å¼€å¯wordleæ¸¸æˆ - å¼€å¯æ’ä»¶åŠŸèƒ½ï¼ˆä»…ç¾¤ç®¡ç†/ç¾¤ä¸»/ä¸»äººï¼‰\n',
        '#å…³é—­wordleæ¸¸æˆ - å…³é—­æ’ä»¶åŠŸèƒ½ï¼ˆä»…ç¾¤ç®¡ç†/ç¾¤ä¸»/ä¸»äººï¼‰\n\n',
        'ğŸ’¡ æç¤ºï¼šé»˜è®¤æ‰€æœ‰ç¾¤ç»„éƒ½æœªå¯ç”¨ï¼Œéœ€è¦å…ˆå‘é€ #å¼€å¯wordleæ¸¸æˆ æ¥å¯ç”¨åŠŸèƒ½ã€‚'
      ],
      [
        'ğŸ“– å•è¯æ¸¸æˆå¸®åŠ©\n\n',
        'ğŸ“‹ åŸºæœ¬å‘½ä»¤ï¼š\n',
        '#word - å¼€å§‹æ–°æ¸¸æˆï¼ˆéšæœºå­—æ¯æ•°é‡ï¼‰\n',
        '#word [æ•°å­—] - å¼€å§‹æŒ‡å®šå­—æ¯æ•°é‡çš„æ¸¸æˆ\n',
        '#word ans - ç»“æŸæ¸¸æˆ\n',
        '#word è¯å…¸ [åç§°] - æŒ‰åç§°åˆ‡æ¢è¯å…¸\n',
        '#é‡Šä¹‰ [å•è¯] - æŸ¥è¯¢å•è¯é‡Šä¹‰\n\n',
        'ğŸ¯ æäº¤çŒœæµ‹æ–¹å¼ï¼š\n',
        'â€¢ ä½¿ç”¨å‰ç¼€ï¼š#apple !apple\n\n',
        'ğŸ“± ä½¿ç”¨ç¤ºä¾‹ï¼š\n',
        '#word 7 - å¼€å§‹7å­—æ¯æ¸¸æˆ\n',
        '#apple - ä½¿ç”¨å‰ç¼€çŒœæµ‹\n',
        '#word è¯å…¸ å››çº§ - åˆ‡æ¢åˆ°å››çº§è¯å…¸\n',
        '#é‡Šä¹‰ access - æŸ¥è¯¢å•è¯accessçš„é‡Šä¹‰'
      ],
      [
        'ğŸ”¢ æ•°å­¦å…¬å¼æ¸¸æˆå¸®åŠ©\n\n',
        'ğŸ“‹ åŸºæœ¬å‘½ä»¤ï¼š\n',
        '#math - å¼€å§‹æ–°æ¸¸æˆï¼ˆé»˜è®¤é•¿åº¦12ï¼‰\n',
        '#math [é•¿åº¦] - å¼€å§‹æŒ‡å®šé•¿åº¦çš„æ¸¸æˆï¼ˆæ”¯æŒ5-12ï¼‰\n',
        '#math ç‰¹æ®Š [é•¿åº¦] - å¼€å§‹ç‰¹æ®Šåˆ†ç±»æ¸¸æˆï¼ˆæ”¯æŒ12ã€14ã€16ï¼ŒåŒ…å«å¹‚è¿ç®—ï¼‰\n',
        '#math ans - ç»“æŸæ¸¸æˆ\n',
        '#math åˆ†ç±» - æŸ¥çœ‹å…¬å¼åˆ†ç±»\n\n',
        'ğŸ¯ æäº¤çŒœæµ‹æ–¹å¼ï¼š\n',
        'â€¢ ä½¿ç”¨å‰ç¼€ï¼š#123+456=579 !123+456=579\n\n',
        'ğŸ“± ä½¿ç”¨ç¤ºä¾‹ï¼š\n',
        '#math 12 - å¼€å§‹é•¿åº¦12çš„æ¸¸æˆ\n',
        '#math ç‰¹æ®Š 14 - å¼€å§‹é•¿åº¦14çš„ç‰¹æ®Šå…¬å¼æ¸¸æˆ\n',
        '#123+456=579 - ä½¿ç”¨å‰ç¼€çŒœæµ‹å…¬å¼\n',
        '#math ç­”æ¡ˆ - ç»“æŸå½“å‰æ¸¸æˆ\n\n',
        'ğŸ’¡ æç¤ºï¼š\n',
        'â€¢ å…¬å¼åŒ…å«æ•°å­—ã€è¿ç®—ç¬¦ï¼ˆ+ã€-ã€*ã€/ã€**ï¼‰å’Œç­‰å·\n',
        'â€¢ æ”¯æŒå¹‚è¿ç®—ï¼ˆ**ï¼‰\n',
        'â€¢ ä¹Ÿå¯ä½¿ç”¨ #æ•°å­¦ æˆ– #å…¬å¼ ä½œä¸ºå‘½ä»¤åˆ«å'
      ],
      [
        'ğŸ€„ æˆè¯­æ¸¸æˆå¸®åŠ©\n\n',
        'ğŸ“‹ åŸºæœ¬å‘½ä»¤ï¼š\n',
        '#idiom - å¼€å§‹æ–°æ¸¸æˆ\n',
        '#idiom ans - ç»“æŸæ¸¸æˆ\n',
        '#idiom å¸®åŠ© - æŸ¥çœ‹å¸®åŠ©\n\n',
        'ğŸ¯ æäº¤çŒœæµ‹æ–¹å¼ï¼š\n',
        'â€¢ ä½¿ç”¨å‰ç¼€ï¼š#é«˜å±±æµæ°´ !é«˜å±±æµæ°´\n\n',
        'ğŸ“± ä½¿ç”¨ç¤ºä¾‹ï¼š\n',
        '#idiom - å¼€å§‹æ–°æ¸¸æˆ\n',
        '#é«˜å±±æµæ°´ - ä½¿ç”¨å‰ç¼€çŒœæµ‹æˆè¯­\n',
        '#idiom ç­”æ¡ˆ - ç»“æŸå½“å‰æ¸¸æˆ\n\n',
        'ğŸ’¡ æç¤ºï¼š\n',
        'â€¢ çŒœä¸€ä¸ªå››å­—æˆè¯­\n',
        'â€¢ æ ¹æ®é¢œè‰²æç¤ºé€æ­¥ç¼©å°èŒƒå›´\n',
        'â€¢ é’è‰²=æ­£ç¡®ä½ç½®ï¼Œæ©™è‰²=å­˜åœ¨ä½†ä½ç½®é”™è¯¯ï¼Œç°è‰²=ä¸å­˜åœ¨\n',
        'â€¢ ä¹Ÿå¯ä»¥ä½¿ç”¨ #æˆè¯­ æˆ– #æ±‰å…œ ä½œä¸ºå‘½ä»¤åˆ«å'
      ]
    ];
    
    await e.reply(common.makeForwardMsg(e, msg, 'Wordle æ¸¸æˆæ’ä»¶å¸®åŠ©'));
    return true;
  }
  
  /**
   * æ£€æŸ¥ç”¨æˆ·æƒé™ï¼ˆç¾¤ç®¡ç†ã€ç¾¤ä¸»ã€æœºå™¨äººä¸»äººï¼‰
   * @param {*} e - æ¶ˆæ¯äº‹ä»¶å¯¹è±¡
   * @returns {boolean} - æ˜¯å¦æœ‰æƒé™
   */
  checkPermission(e) {
    // æœºå™¨äººä¸»äººå§‹ç»ˆæœ‰æƒé™
    if (e.isMaster) {
      return true;
    }
    
    // ç§èŠåªæœ‰æœºå™¨äººä¸»äººå¯ä»¥ä½¿ç”¨
    if (!e.isGroup) {
      return false;
    }
    
    // ç¾¤èŠï¼šç¾¤ä¸»æˆ–ç®¡ç†å‘˜å¯ä»¥ä½¿ç”¨
    if (e.member?.is_owner || e.member?.is_admin) {
      return true;
    }
    
    return false;
  }

  /**
   * å¼€å¯/å…³é—­Wordleæ¸¸æˆ
   * @param {*} e - æ¶ˆæ¯äº‹ä»¶å¯¹è±¡
   * @returns {Promise<boolean>} - å¤„ç†ç»“æœ
   */
  async toggleWordle(e) {
    const match = e.msg.match(/^#(å¼€å¯|å…³é—­)wordleæ¸¸æˆ$/i);
    if (!match) {
      return false;
    }
    
    // æ£€æŸ¥æƒé™
    if (!this.checkPermission(e)) {
      if (!e.isGroup) {
        await e.reply('âŒ ç§èŠä¸­åªæœ‰æœºå™¨äººä¸»äººå¯ä»¥ä½¿ç”¨æ­¤åŠŸèƒ½ã€‚');
      } else {
        await e.reply('âŒ æš‚æ— æƒé™ï¼Œåªæœ‰ç¾¤ç®¡ç†ã€ç¾¤ä¸»å¯ä»¥ä½¿ç”¨æ­¤åŠŸèƒ½ã€‚');
      }
      return true;
    }
    
    const action = match[1];
    const groupId = e.group_id || `private_${e.user_id}`;
    const dbModule = this.db || db;
    this.db = dbModule;
    
    if (action === 'å¼€å¯') {
      const success = await dbModule.enableGroup(groupId);
      if (success) {
        await e.reply('âœ… Wordleæ¸¸æˆåŠŸèƒ½å·²å¼€å¯ï¼ç°åœ¨å¯ä»¥ä½¿ç”¨äº†ï¼Œå‘½ä»¤ä¸º #wordle å¸®åŠ©ã€‚');
        return true;
      } else {
        await e.reply('âŒ å¼€å¯å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•ã€‚');
        return true;
      }
    } else if (action === 'å…³é—­') {
      const success = await dbModule.disableGroup(groupId);
      if (success) {
        await e.reply('âŒ Wordleæ¸¸æˆå·²å…³é—­ã€‚');
        return true;
      } else {
        await e.reply('âŒ å…³é—­å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•ã€‚');
        return true;
      }
    }
    
    return false;
  }
}

